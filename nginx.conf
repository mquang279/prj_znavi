# API Gateway
server {
    listen 80;
    server_name localhost;
    
    error_log /var/log/nginx/gateway-error.log;
    access_log /var/log/nginx/gateway-access.log;

    location = /_auth {
        internal;
        fastcgi_pass auth-service:9000;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME /var/www/public/index.php;
        fastcgi_param REQUEST_URI /api/auth/verify;
        fastcgi_param QUERY_STRING "";
        fastcgi_param REQUEST_METHOD GET;
        fastcgi_param HTTP_AUTHORIZATION $http_authorization;
        include fastcgi_params;
        
        fastcgi_param HTTP_X_ORIGINAL_URI $request_uri;
        fastcgi_param HTTP_X_ORIGINAL_METHOD $request_method;
        
        fastcgi_pass_request_body off;
        fastcgi_param CONTENT_LENGTH "";
    }

    location /api/auth/login {
        fastcgi_pass auth-service:9000;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME /var/www/public/index.php;
        fastcgi_param REQUEST_URI $uri;
        fastcgi_param QUERY_STRING $query_string;
        include fastcgi_params;
    }

    location /api/auth/register {
        fastcgi_pass auth-service:9000;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME /var/www/public/index.php;
        fastcgi_param REQUEST_URI $uri;
        fastcgi_param QUERY_STRING $query_string;
        include fastcgi_params;
    }

    location /api/auth {
        auth_request /_auth;
        auth_request_set $user_id $upstream_http_x_user_id;
        auth_request_set $user_email $upstream_http_x_user_email;
        auth_request_set $user_roles $upstream_http_x_user_roles;
        auth_request_set $user_permissions $upstream_http_x_user_permissions;

        fastcgi_pass auth-service:9000;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME /var/www/public/index.php;
        fastcgi_param REQUEST_URI $uri;
        fastcgi_param QUERY_STRING $query_string;
        fastcgi_param HTTP_X_USER_ID $user_id;
        fastcgi_param HTTP_X_USER_EMAIL $user_email;
        fastcgi_param HTTP_X_USER_ROLES $user_roles;
        fastcgi_param HTTP_X_USER_PERMISSIONS $user_permissions;
        include fastcgi_params;
    }

    location /api/inventory {
        auth_request /_auth;
        auth_request_set $user_id $upstream_http_x_user_id;
        auth_request_set $user_email $upstream_http_x_user_email;
        auth_request_set $user_roles $upstream_http_x_user_roles;
        auth_request_set $user_permissions $upstream_http_x_user_permissions;

        fastcgi_pass inventory-service:9000;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME /var/www/public/index.php;
        fastcgi_param REQUEST_URI $uri;
        fastcgi_param QUERY_STRING $query_string;
        fastcgi_param HTTP_X_USER_ID $user_id;
        fastcgi_param HTTP_X_USER_EMAIL $user_email;
        fastcgi_param HTTP_X_USER_ROLES $user_roles;
        fastcgi_param HTTP_X_USER_PERMISSIONS $user_permissions;
        include fastcgi_params;
    }

    location /api/billing {
        auth_request /_auth;
        auth_request_set $user_id $upstream_http_x_user_id;
        auth_request_set $user_email $upstream_http_x_user_email;
        auth_request_set $user_roles $upstream_http_x_user_roles;
        auth_request_set $user_permissions $upstream_http_x_user_permissions;

        fastcgi_pass billing-service:9000;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME /var/www/public/index.php;
        fastcgi_param REQUEST_URI $uri;
        fastcgi_param QUERY_STRING $query_string;
        fastcgi_param HTTP_X_USER_ID $user_id;
        fastcgi_param HTTP_X_USER_EMAIL $user_email;
        fastcgi_param HTTP_X_USER_ROLES $user_roles;
        fastcgi_param HTTP_X_USER_PERMISSIONS $user_permissions;
        include fastcgi_params;
    }

    error_page 401 = @error401;
    location @error401 {
        default_type application/json;
        return 401 '{"error": "Unauthorized", "message": "Invalid or missing JWT token"}';
    }

    location /health {
        return 200 '{"status": "ok"}';
        add_header Content-Type application/json;
    }
}